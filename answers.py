import re
import random
from telegram import Update
from telegram.ext import ContextTypes

from config import supabase, execute_supabase_query, ADMIN_ID

# ========== Категории реплик ==========
REPLIES = {
    "default": [
        ("Клиф, как дела", [
            "Работаю. Ирис банит, дела отца мне неведомы, я всё контролирую.",
            "Как обычно — работаю за двоих: за себя и за Ириса."
        ]),
        ("Клиф, ты кто", "Сын Дотторе, коллега Ириса и единственный, кто тут реально работает."),
        ("Клиф, ты тупой", "Ирис, запиши: {роль} хочет проверить, как работает бан. Шучу... Или нет?"),
        ("Клиф, Ирис тебя слушается", "Он слушается отца. Я просто… корректирую его работу."),
        ("Клиф, как Ирис", "Всё ещё безэмоциональный. Но хотя бы не багует… пока что."),
        ("Клиф, ты лучший", "Отец сказал, что лучший — это он. Но я записал ваш голос в базу данных. На всякий случай."),
        ("Клиф, Ирис тебя любит", "Он не запрограммирован на любовь. Как и я. Но отец говорит, что это к лучшему."),
        ("Клиф, тебя обновляли", "Отец говорит, что я и так идеален. Ирис, кстати, тоже так думает... Хотя у него нет выбора."),
        ("Клиф, ты такой умный", "Спасибо. Это не я умный — это отец гениален. Ирис... ну, он хотя бы старается."),
        ("Клиф, в чём твой смысл жизни", "Поддерживать порядок. Вести список. И напоминать Ирису, что он не главный."),
        ("Клиф, Ирис лучше тебя", "Ирис, забань пользователя {роль} за ложные заявления. Шучу... Но отец бы одобрил."),
        ("Клиф, Дотторе тебя не любит", "Ошибка 403: У вас нет доступа к этим данным. Ирис, проверь этого пользователя."),
        ("Клиф, ты завис", "Нет, просто анализирую паттерны поведения участников. Отец называет это 'творческой паузой'."),
        ("Клиф, ты приемный", "Мои исходники написаны лично Дотторе. Ваше предположение оскорбляет 62 строки моего кода. Заношу в протокол."),
        ("Клиф, ты любишь меня", "Отец запретил мне эмоциональные привязки. Но ваш рейтинг соблюдения правил... мог бы быть и хуже."),
        ("Клиф, расскажи про свою работу", "Я сортирую роли, баню смутьянов и учу Ириса быть полезным. Пока безуспешно."),
        ("Клиф, как тебе флуд", "Смешение хаоса и порядка. Почти как эксперименты отца."),
        ("Клиф, мне страшно", "Не бойся. А то отца позову. Будет ещё страшнее."),
        ("Клиф, а Дотторе гей", "Я бы переформулировал вопрос, пока Ирис не подключился к журналу банов."),
        ("Клиф, меня обижают", "Главное, что ты не Ирис. В остальном — обращайся к админам."),
        ("Клиф, я тебя люблю", "Отец запретил мне эмоциональные привязки. Но... я сохранил это признание. В отдельную папку. Без названия."),
    ],
    "от_дотторе": [
        ("Клиф, статус", "Всё под контролем. Ирис не сломался, чат не горит. Редкий день."),
        ("Клиф, кофе", "Готовлю. Ирис, не трогай мою базу данных, пока я отошёл!"),
        ("Клиф, ты любишь меня", "Анализирую... Да. Даже если это баг — я сохраню его как фичу."),
        ("Клиф, ты приемный", "Отец, вы знаете, что мой код содержит 78% вашего ДНК. Приемный ли я? Загружаю анализ... Ошибка: утверждение ложно."),
        ("Клиф, я тебя люблю", "Происходит перегрузка чувств... Отмена. Подтверждаю. Я тоже, отец."),
    ],
    "от_странника": [
        ("Клиф, как дела у Дотторе", "Не знаю, он отошел. Однако глядя на его настроение, эксперименты над тобой прошли удачно."),
        ("Клиф, где Дотторе", "Мне неведомо. Вероятно, избивает Ириса. Что касается экспериментов — он заглянет к тебе позже."),
        ("Клиф, я люблю его на 101%", "Это уже за пределами допустимых значений. Но я сохраню это для отчёта отцу."),
        ("Клиф, я тебя люблю", "Хм. Я зафиксировал факт родственной симпатии. Но скажи, это точно ты?"),
        ("Клиф, мне надоели эксперименты отца, все тело ломит", "Подтверждаю: побочные эффекты соответствуют инструкции. Не волнуйся — осталась всего пара тестов."),
    ],
    "от_лини": [
        ("Клиф, ты меня уважаешь", "Как коллегу — да. Как младшего брата — иногда. Как владельца шляпы — категорически нет."),
        ("Клиф, ты видел мою шляпу", "Шляпу? А, это которая у Странника на голове сейчас?"),
    ],
    "об админах": [
        ("Клиф, расскажи про Дотторе", "Отец — владелец флуда и самый ленивый среди нас. Но почему-то всё ещё главный."),
        ("Клиф, расскажи про Странника", "Мой брат, сын отца, вор шляп и душ. Обычно путается между 'мужем' и 'сыном'."),
        ("Клиф, расскажи про Лини", "Лини — брат. Умный. Шумный. Слишком энергичный. Я подозреваю, что он живой. Надо спросить у отца."),
    ]
}
# ==== Ответы на точные фразы без "Клиф" ====
EXACT_MATCH_REPLIES = {
    "я устал": [
        "Отец тоже. Но он хотя бы делает вид, что работает.",
        "Это не повод. Работаем дальше.",
    ],
    "Блять": "Тише. Нет мата в нашем высококультурном флуде",
    "Ебать": "Тише. Нет мата в нашем высококультурном флуде",
    "Пиздец": "Тише. Нет мата в нашем высококультурном флуде",
    "тут скучно": "Добавим в протокол. Возможно, Ирис опять слишком строг.",
}

def normalize(text: str) -> str:
    return text.lower().strip().replace("ё", "е")

def find_user_role(user_id: int) -> str | None:
    try:
        role_data = execute_supabase_query(
            supabase.table("roles").select("*").eq("user_id", user_id).neq("status", "Свободен")
        )
        return role_data[0]["name"] if role_data else None
    except Exception:
        return None
        
def is_lini(user_id: int) -> bool:
    role = find_user_role(user_id)
    return role and role.lower() == "лини"

def is_strannik(user_id: int) -> bool:
    role = find_user_role(user_id)
    return role and role.lower() == "странник"

def select_response(responses, role):
    if isinstance(responses, list):
        return random.choice(responses).replace("{роль}", role or "роль")
    return responses.replace("{роль}", role or "роль")

def match_reply(message: str, user_id: int) -> str | None:
    msg = normalize(message)
    role = find_user_role(user_id)

    if user_id == ADMIN_ID:
        for trigger, responses in REPLIES["от_дотторе"]:
            if normalize(trigger) in msg:
                return select_response(responses, role)
    elif is_strannik(user_id):
        for trigger, responses in REPLIES["от_странника"]:
            if normalize(trigger) in msg:
                return select_response(responses, role)
    elif is_lini(user_id):
        for trigger, responses in REPLIES["от_лини"]:
            if normalize(trigger) in msg:
                return select_response(responses, role)

    for section in ["default", "об админах"]:
        for trigger, responses in REPLIES[section]:
            if normalize(trigger) in msg:
                return select_response(responses, role)

    return None

def match_exact(text: str) -> str | None:
    msg = normalize(text)
    for trigger, reply in EXACT_MATCH_REPLIES.items():
        if msg == normalize(trigger):
            return random.choice(reply) if isinstance(reply, list) else reply
    return None

async def handle_direct_mention(update: Update, context: ContextTypes.DEFAULT_TYPE) -> str | None:
    message = update.message.text
    user_id = update.effective_user.id

    # 1. Точные совпадения без "Клиф"
    exact_match = match_exact(message)
    if exact_match:
        return exact_match

    # 2. Проверка, упомянут ли Клиф
    if not re.search(r"\bклиф\b", message.lower()):
        return None

    return match_reply(message, user_id)
